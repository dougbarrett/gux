---
phase: 06-progressive-enhancement
plan: 02
type: execute
domain: go-wasm
---

<objective>
Set up PWA foundation with manifest and service worker for asset caching.

Purpose: Enable installation to home screen and faster subsequent loads through WASM caching.
Output: manifest.json, service-worker.js, updated index.html with PWA meta tags.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/06-progressive-enhancement/06-01-PLAN.md

# Existing HTML structure:
@example/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PWA manifest and icons</name>
  <files>example/manifest.json, example/icons/ (directory), example/index.html</files>
  <action>
Create manifest.json with:
- name: "GoQuery"
- short_name: "GoQuery"
- description: "Database query tool built with Go and WebAssembly"
- start_url: "/"
- display: "standalone"
- background_color: "#ffffff"
- theme_color: "#3b82f6" (Tailwind blue-500)
- icons array with sizes: 192x192, 512x512

Create placeholder icons:
- Create example/icons/ directory
- Generate simple SVG icons (can be colored squares with "GQ" text for now)
- icon-192.png and icon-512.png placeholders

Update index.html:
- Add link rel="manifest" href="manifest.json"
- Add meta name="theme-color" content="#3b82f6"
- Add meta name="apple-mobile-web-app-capable" content="yes"
- Add meta name="apple-mobile-web-app-status-bar-style" content="default"
- Add link rel="apple-touch-icon" href="icons/icon-192.png"
  </action>
  <verify>Open index.html in browser, check DevTools > Application > Manifest shows valid manifest with no errors</verify>
  <done>Manifest loads correctly, icons referenced, PWA installable (Chrome shows install icon in address bar)</done>
</task>

<task type="auto">
  <name>Task 2: Create service worker for asset caching</name>
  <files>example/service-worker.js, example/index.html</files>
  <action>
Create service-worker.js with cache-first strategy:
- Cache name: "goquery-v1"
- Precache list: ["/", "/index.html", "/wasm_exec.js", "/main.wasm", "/manifest.json"]
- Install event: Open cache, add all precache URLs
- Fetch event:
  - For same-origin requests: Try cache first, fallback to network, cache successful responses
  - For CDN resources (jsPDF): Network first, cache fallback (don't block on CDN)
- Activate event: Clean old caches (any not matching current cache name)

Register service worker in index.html:
- Add script block after WASM initialization
- Check for 'serviceWorker' in navigator
- Register '/service-worker.js'
- Log registration success/failure to console

Important considerations:
- WASM files are large, cache is essential for performance
- Use async/await syntax for clarity
- Handle fetch errors gracefully (return cached or offline page)
  </action>
  <verify>Open DevTools > Application > Service Workers shows "Activated and running". Cache Storage shows cached files. Reload page with DevTools Network tab open - cached files show "(from service worker)"</verify>
  <done>Service worker registered, assets cached, subsequent loads use cache, offline shows cached content</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PWA manifest and service worker with asset caching</what-built>
  <how-to-verify>
    1. Start dev server: cd example && make dev (or go run server)
    2. Open http://localhost:8080 in Chrome
    3. Open DevTools (F12) > Application tab
    4. Check "Manifest" section - should show app info and icons
    5. Check "Service Workers" - should show "Activated and running"
    6. Check "Cache Storage" - should show "goquery-v1" with cached files
    7. Look for install icon in Chrome address bar (+ icon or computer icon)
    8. Reload page, check Network tab - files should show "(from service worker)"
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] manifest.json valid (no DevTools errors)
- [ ] Service worker registered and active
- [ ] Assets cached in Cache Storage
- [ ] Subsequent page loads use cached assets
- [ ] PWA install prompt available in supported browsers
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PWA scores well in Lighthouse audit (Application section)
- Assets load from cache on repeat visits
</success_criteria>

<output>
After completion, create `.planning/phases/06-progressive-enhancement/06-02-SUMMARY.md` using template from ./summary.md
</output>
