---
phase: 06-progressive-enhancement
plan: 03
type: execute
domain: go-wasm
---

<objective>
Create PWA install prompt component and offline fallback experience.

Purpose: Encourage users to install the app and provide graceful offline handling.
Output: InstallPrompt component, offline.html fallback page, completed Phase 6.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/06-progressive-enhancement/06-01-PLAN.md
@.planning/phases/06-progressive-enhancement/06-02-PLAN.md

# Component patterns:
@components/alert.go
@components/button.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InstallPrompt component</name>
  <files>components/install_prompt.go, example/app/main.go</files>
  <action>
Create InstallPrompt component:
- InstallPromptProps: Position (bottom-left, bottom-right, top-center), OnDismiss callback, OnInstall callback
- Store reference to beforeinstallprompt event using js.Value
- Show prompt banner with:
  - App icon (small)
  - Text: "Install GoQuery for faster access"
  - "Install" button (primary)
  - "Not now" button (secondary/text)
- Hide automatically after install or dismiss
- Store dismissal in localStorage to avoid showing repeatedly (show again after 7 days)

JavaScript interop:
- Listen for 'beforeinstallprompt' event on window
- Store event.preventDefault() to defer prompt
- Call event.prompt() when user clicks Install
- Handle 'appinstalled' event to update state

Component API:
- InstallPrompt(props) - the banner component
- NewInstallPromptManager() - manages the beforeinstallprompt event lifecycle
- manager.CanInstall() bool - returns true if install is available
- manager.ShowPrompt() - shows native install prompt
- manager.OnCanInstall(callback) - register callback for when install becomes available

Add to example app:
- Initialize InstallPromptManager in main()
- Render InstallPrompt component when canInstall is true
- Position at bottom-right with slight margin
  </action>
  <verify>GOOS=js GOARCH=wasm go build -o /dev/null ./components/install_prompt.go compiles. In Chrome, check that beforeinstallprompt is captured (log to console)</verify>
  <done>InstallPrompt component compiles, captures beforeinstallprompt event, shows banner when installable, Install button triggers native prompt</done>
</task>

<task type="auto">
  <name>Task 2: Create offline fallback page and update service worker</name>
  <files>example/offline.html, example/service-worker.js</files>
  <action>
Create offline.html:
- Clean, centered message: "You're offline"
- Icon: Cloud with X or similar (use emoji: ☁️❌ or SVG)
- Text: "GoQuery requires a database connection to function."
- Subtext: "Please check your internet connection and try again."
- "Try Again" button that calls location.reload()
- Style with inline Tailwind-like CSS (since Tailwind may not be cached)
- Dark mode support via prefers-color-scheme media query

Update service-worker.js:
- Add '/offline.html' to precache list
- Modify fetch handler:
  - For navigation requests (mode === 'navigate'): If network fails and no cache, return offline.html
  - For other requests: Return cached or fail gracefully
- Add helper function: isNavigationRequest(request)

Test offline behavior:
- In DevTools > Application > Service Workers, check "Offline"
- Refresh page - should show offline.html
- Uncheck "Offline" - should work normally
  </action>
  <verify>With DevTools offline mode enabled, page shows offline.html. "Try Again" button reloads. Disable offline mode, page works normally</verify>
  <done>offline.html displays when network unavailable, service worker serves it for failed navigation, "Try Again" reloads page</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PWA install prompt and offline fallback experience</what-built>
  <how-to-verify>
    1. Start dev server: cd example && make dev
    2. Open http://localhost:8080 in Chrome (Incognito for fresh state)
    3. Wait for InstallPrompt banner at bottom-right (may take a few seconds)
    4. Click "Install" - native Chrome install dialog should appear
    5. Dismiss dialog, click "Not now" on banner - should hide
    6. Open DevTools > Application > Service Workers
    7. Check "Offline" checkbox
    8. Refresh page - should show offline.html with retry button
    9. Click "Try Again" (will fail while offline)
    10. Uncheck "Offline", click "Try Again" - app should load
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues. Phase 6 complete after approval.</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] InstallPrompt captures beforeinstallprompt event
- [ ] Install button triggers native install dialog
- [ ] Banner dismissal persisted in localStorage
- [ ] offline.html serves when network unavailable
- [ ] Service worker handles navigation failures gracefully
- [ ] Phase 6 milestone complete
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PWA install flow works end-to-end
- Offline fallback provides clear user feedback
- Phase 6: Progressive Enhancement complete
- v1.0 UX Polish milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-progressive-enhancement/06-03-SUMMARY.md` using template from ./summary.md

This plan completes Phase 6 and the v1.0 UX Polish milestone. Update STATE.md and ROADMAP.md to reflect completion.
</output>
