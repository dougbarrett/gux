---
phase: 09-keyboard-navigation
plan: 01
type: execute
---

<objective>
Implement focus trap and focus restoration for Modal component.

Purpose: Prevent keyboard users from tabbing out of modal dialogs (WCAG 2.1.2) and restore focus to trigger element on close (WCAG 2.4.3). These are P0 Critical accessibility gaps.
Output: Modal with proper focus management that traps focus within dialog and returns focus on close.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 8 established ARIA patterns:
@.planning/phases/08-aria-semantic-markup/08-01-SUMMARY.md

# Existing keyboard patterns to follow:
@.planning/phases/04-ux-polish/04-02-SUMMARY.md

# Component to modify:
@components/modal.go

# Reference for keyboard handling pattern:
@components/dropdown.go (keyHandler pattern with cleanup)
@components/command_palette.go (focus management pattern)

**Tech stack available:** Go/WASM, syscall/js
**Established patterns:**
- keydown event listener with js.Func cleanup
- crypto.randomUUID() for unique IDs
- Store trigger reference for focus restoration

**Constraining decisions:**
- Phase 08-01: Modal has role="dialog", aria-modal="true", aria-labelledby
- Phase 04-02: Keyboard handlers use js.Func with Release() for cleanup

**Issues being addressed:**
- P0 #1: Modal no focus trap - focus escapes dialog
- P0 #2: Modal no focus restoration on close
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add focus trap to Modal</name>
  <files>components/modal.go</files>
  <action>
Implement focus trap that keeps Tab/Shift+Tab within the modal:

1. Add `focusTrap js.Func` field to Modal struct for cleanup
2. Add `triggerElement js.Value` field to store the element that opened the modal
3. In Open():
   - Store document.activeElement as triggerElement before showing modal
   - Query all focusable elements: 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
   - Set up keydown handler that intercepts Tab:
     - If Tab on last focusable element, move focus to first
     - If Shift+Tab on first focusable element, move focus to last
   - Focus the first focusable element (or close button, or modal itself)

4. Store the keydown handler as focusTrap for cleanup in Close()

Follow the dropdown.go keyHandler pattern: create js.Func, add to document, store for removal.
  </action>
  <verify>
Manual test: Open modal, Tab through all elements, verify focus wraps from last to first.
Shift+Tab from first element wraps to last. Focus cannot escape to elements behind modal.
  </verify>
  <done>Tab/Shift+Tab cycles within modal, focus never escapes to background elements</done>
</task>

<task type="auto">
  <name>Task 2: Add focus restoration on Modal close</name>
  <files>components/modal.go</files>
  <action>
Restore focus to the trigger element when modal closes:

1. In Close():
   - Remove the focusTrap keydown event listener
   - Call focusTrap.Release() to clean up js.Func
   - If triggerElement is valid (!IsUndefined() && !IsNull()), call triggerElement.Call("focus")

2. Ensure focus restoration happens AFTER the modal is hidden (classList.add("hidden"))

3. Handle edge case: if trigger element no longer exists in DOM, don't error

Follow the dropdown.go pattern for cleanup: removeEventListener then Release().
  </action>
  <verify>
Manual test: Click button to open modal, close modal (via X, Escape, or overlay click), verify focus returns to the button that opened it.
  </verify>
  <done>Focus returns to trigger element after modal closes via any method (X button, Escape, overlay click)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Modal traps focus - Tab cycles within modal
- [ ] Modal traps focus - Shift+Tab cycles within modal
- [ ] Focus moves to first focusable element on open
- [ ] Focus returns to trigger on close via X button
- [ ] Focus returns to trigger on close via Escape key
- [ ] Focus returns to trigger on close via overlay click
- [ ] No console errors when opening/closing modal
- [ ] `go build ./...` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Modal focus management meets WCAG 2.1.2 and 2.4.3
- No memory leaks (js.Func properly released)
</success_criteria>

<output>
After completion, create `.planning/phases/09-keyboard-navigation/09-01-SUMMARY.md`
</output>
