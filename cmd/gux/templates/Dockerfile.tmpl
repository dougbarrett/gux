# Multi-stage Dockerfile for {{.AppName}}
# Produces a single binary with all static assets embedded

# Stage 1: Build with TinyGo using gux
FROM tinygo/tinygo:latest AS builder

WORKDIR /app

# Copy go.mod and go.sum first for better caching
COPY go.mod go.sum* ./
RUN go mod download || true

# Install gux CLI
ENV GOBIN=/app/bin
ENV PATH="/app/bin:${PATH}"
RUN mkdir -p /app/bin && go install {{.GuxModule}}/cmd/gux@{{.GuxVersion}}

# Copy source code with correct ownership for non-root user
COPY --chown=tinygo:tinygo . .

# Build everything: WASM + server binary with embedded assets
# TinyGo is the default compiler (no flags needed)
RUN gux setup && gux build

# Stage 2: Minimal production image
FROM alpine:3.21

WORKDIR /app

# Install CA certificates for HTTPS
RUN apk add --no-cache ca-certificates

# Copy the single binary (all assets are embedded)
COPY --from=builder /app/server .

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1

# Run server
CMD ["./server", "-port", "8080"]
